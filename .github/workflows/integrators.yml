name: Integrators

on: [push, pull_request]

concurrency:
  # cancel older, in-progress jobs from the same PR, same workflow.
  # use run_id if the job is triggered by a push to ensure
  # push-triggered jobs to not get canceled.
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  era-compiler-tester:
    runs-on: ubuntu-latest
  
    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - name: Rust setup
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly-2022-11-03

    - name: Set up Python ${{ matrix.python-version[0] }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version[0] }}

    - name: Install Vyper
      run: pip install .

    - name: Initialize repository and submodules
      run: |
        git clone --depth 1 https://github.com/matter-labs/era-compiler-tester.git
        cd era-compiler-tester
        sed -i 's/ssh:\/\/git@/https:\/\//g' .gitmodules
        git submodule init
        git submodule update
        cd ..

    - name: Install dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        sudo apt install cmake ninja-build clang-13 lld-13 parallel pkg-config
        cd era-compiler-tester
        zkevm-llvm clone && zkevm-llvm build
        cargo build --release
        cd ..

    - name: Copy Vyper binary
      run: |
        cd era-compiler-tester
        mkdir vyper-bin
        echo $(which vyper)
        cp $(which vyper) vyper-bin/vyper-0.3.8
        cd ..

    - name: Run tester with optimization for Vyper
      run: |
        cd era-compiler-tester
        cargo run --release --bin compiler-tester -- -v --path='tests/vyper/' --mode='M0B0'
        cd ..
